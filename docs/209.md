# Tidyverse - purrr

* 関数型プログラミングを拡張するパッケージ
* `map` 関数や `walk` 関数を使うことでループ処理を簡潔に表現できる
* 処理は高速であり、また関数名も一貫性があり使いやすい

https://purrr.tidyverse.org/

> 以下のサンプルコードは `library(tidyverse)` あるいは `library(purrr)` を実行した後に記述します。

---

## 主要な操作

|関数名|処理内容|
|:--|:--|
|map|リストやベクトルなどのデータに対して関数を適用した結果を返す|
|map2|2つのリストやベクトルなどのデータに対して関数を適用した結果を返す|
|pmap|任意の数のリストやベクトルなどのデータに対して関数を適用した結果を返す|
|walk|リストやベクトルなどのデータに対して関数を適用する（戻り値はない）|
|walk2|2つのリストやベクトルなどのデータに対して関数を適用する（戻り値はない）|
|pwalk|任意の数のリストやベクトルなどのデータに対して関数を適用する（戻り値はない）|

> purrr には他にも様々な関数が用意されています。 参考： https://raw.githubusercontent.com/rstudio/cheatsheets/master/pngs/thumbnails/forcats-cheatsheet-thumbs.png

---

## `map` ファミリー

### `map` 関数

* `map` 関数はリストやベクトルなどのデータに対して関数を適用した結果を返却する
* `map` 関数は第1引数（ `.x` ） に対象データ、第2引数（ `.f` ）に適用する関数を指定する（指定した関数に渡すパラメータも名前付き引数で指定可能）
* `map` 関数は無名関数をショートハンドで定義できる

```r
library(tidyverse)
map(1:3, rnorm)
map(1:3, rnorm, n = 5)
map(1:3, function(e) rnorm(n = 3, mean = 10, sd = 5))
map(1:3, ~ rnorm(n = ., mean = 10, sd = 5))
```

#### 実行結果

```r
> library(tidyverse)
> map(1:3, rnorm)
[[1]]
[1] -0.3042922

[[2]]
[1] -0.3083161  0.6973506

[[3]]
[1]  0.1564607 -1.2334231  0.6453248

> map(1:3, rnorm, n = 5)
[[1]]
[1] 0.0325995 0.7749048 2.0141641 0.8276805 2.5658073

[[2]]
[1] 1.5189023 2.4336649 2.8724496 0.9667854 2.8117833

[[3]]
[1] 4.939012 3.553610 3.175282 2.567691 5.233556

> map(1:3, function(e) rnorm(n = 3, mean = 10, sd = 5))
[[1]]
[1] 12.462849  4.849562 15.057452

[[2]]
[1] 15.6629000 -0.1739525  7.0949226

[[3]]
[1]  9.877302  5.130292 12.214512

> map(1:3, ~ rnorm(n = ., mean = 10, sd = 5))
[[1]]
[1] 2.469093

[[2]]
[1] 15.56211 15.84967

[[3]]
[1] 6.463437 6.848925 6.372802

```

#### 関数のショートハンド定義

* map関数など一部の関数には無名関数のショートハンドがサポートされている
* `function` キーワードの代わりに `~` 記号を利用できる
* 関数が1つの引数を処理する場合は `.` 、関数が2つの引数を処理する場合は `.x` と `.y` 、3つ以上の引数を処理する場合は `..1` 、`..2` 、`..3` のようにして引数にアクセスできる 

```r
# 無名関数
function (x) x * 2
function (x, y) x * y
function (x, y , z) x * y * z

# map関数の無名関数の定義
~ . * 2
~ .x * .y
~ ..1 * ..2 * ..3
```

#### `map` 関数の戻り値の型について

* `map` 関数は関数を適用した結果をリストデータで返却する
* 戻り値を任意の型のベクトルで受け取りたい場合は `map_dbl` 関数や `map_chr` 関数などを使う

```r
map(1:3, sqrt)
map_dbl(1:3, sqrt)
map_chr(1:3, sqrt)
```

#### 実行結果

```r
> map(1:3, sqrt)
[[1]]
[1] 1

[[2]]
[1] 1.414214

[[3]]
[1] 1.732051

> map_dbl(1:3, sqrt)
[1] 1.000000 1.414214 1.732051
> map_chr(1:3, sqrt)
[1] "1.000000" "1.414214" "1.732051"
```

---

### `map2` 関数

* `map2` 関数は2つのリストやベクトルなどのデータに対して関数を適用した結果を返却する
* `map2` 関数は第1引数（ `.x` ） に1つ目の対象データ、第2引数（ `.y` ）に2つ目の対象データ、第3引数（ `.f` ）に適用する関数を指定する（指定した関数に渡すパラメータも名前付き引数で指定可能）
* 2つの引数 `.x` と `.y` のサイズは一致している必要がある

```r
tbl <- tribble(
  ~x, ~y, ~z,
  1, 10, 100,
  2, 20, 200,
  3, 30, 300,
)
map2(tbl$x, tbl$y, function(x, y) x + y)
map2(tbl$x, tbl$y, ~ .x + .y)
map2_dbl(tbl$x, tbl$y, ~ .x + .y)
```

> `map2` 関数において、無名関数をショートハンドで定義した場合は2つの引数 `.x` 、 `.y` を使用します。

#### 実行結果

```r
> tbl <- tribble(
+   ~x, ~y, ~z,
+   1, 10, 100,
+   2, 20, 200,
+   3, 30, 300,
+ )
> map2(tbl$x, tbl$y, function(x, y) x + y)
[[1]]
[1] 11

[[2]]
[1] 22

[[3]]
[1] 33

> map2(tbl$x, tbl$y, ~ .x + .y)
[[1]]
[1] 11

[[2]]
[1] 22

[[3]]
[1] 33

> map2_dbl(tbl$x, tbl$y, ~ .x + .y)
[1] 11 22 33

```

> `map2` 関数も `map` 関数と同様に `map2_dbl` 関数などを使うことで戻り値を任意の型のベクトルに変換できます。

---

### `pmap` 関数

* `pmap` 関数は任意の数のリストやベクトルなどのデータに対して関数を適用した結果を返却する
* `pmap` 関数は第1引数にデータフレームなどのリストデータを受け取り、第2引数（ `.f` ）に適用する関数を指定する
* `map` や `map2` で処理できない3つ以上の要素を持つリストをまとめて処理するときに利用できる


```r
tbl <- tribble(
  ~x, ~y, ~z,
  1, 10, 100,
  2, 20, 200,
  3, 30, 300,
)
pmap(tbl, function(x, y, z) x + y + z)
pmap(tbl, ~ ..1 + ..2 + ..3)
pmap_dbl(tbl, ~ ..1 + ..2 + ..3)
```


#### 実行結果

```r
> tbl <- tribble(
+   ~x, ~y, ~z,
+   1, 10, 100,
+   2, 20, 200,
+   3, 30, 300,
+ )
> pmap(tbl, function(x, y, z) x + y + z)
[[1]]
[1] 111

[[2]]
[1] 222

[[3]]
[1] 333

> pmap(tbl, ~ ..1 + ..2 + ..3)
[[1]]
[1] 111

[[2]]
[1] 222

[[3]]
[1] 333

> pmap_dbl(tbl, ~ ..1 + ..2 + ..3)
[1] 111 222 333
```

> `pmap` 関数において無名関数をショートハンドで定義した場合は、1つ目の引数は `..1` 、2つ目の引数は `..2` のように引数の番号を指定してアクセスできます。

---

## `walk` ファミリー

### `walk` 関数

* `walk` 関数はリストやベクトルなどのデータに対して関数を適用する（戻り値はない）
* `walk` 関数は第1引数（ `.x` ） に対象データ、第2引数（ `.f` ）に適用する関数を指定する（指定した関数に渡すパラメータも名前付き引数で指定可能）
* `walk` 関数はコンソールへのデータの出力など（副作用）のある処理に使う

```r
walk(1:3, print)
walk(1:3, function(e) write("Hello", paste0("1-", e, ".txt")))
walk(1:3, ~ write("Hello2", paste0("2-", ., ".txt")))
```

> `walk` 関数も無名関数をショートハンドで定義できます。

#### 実行結果

```r
> walk(1:3, print)
[1] 1
[1] 2
[1] 3
> walk(1:3, function(e) write("Hello", paste0("1-", e, ".txt")))
> walk(1:3, ~ write("Hello2", paste0("2-", ., ".txt")))
```

> 1-1.txt 〜 1-3.txt、2-1.txt 〜 2-3.txt 合計6つのファイルが生成されます。

---

### `walk2` 関数

* `walk2` 関数は2つのリストやベクトルなどのデータに対して関数を適用する（戻り値はない）
* `walk2` 関数は第1引数（ `.x` ） に1つ目の対象データ、第2引数（ `.y` ）に2つ目の対象データ、第3引数（ `.f` ）に適用する関数を指定する（指定した関数に渡すパラメータも名前付き引数で指定可能）
* 2つの引数 `.x` と `.y` のサイズは一致している必要がある

```r
lst <- list(
  x = c(1, 2, 3),
  y = c(10, 20, 30),
  z = c(100, 200, 300)
)
walk2(lst$x, lst$y, ~ print(.x + .y))
```

> `walk` 関数も無名関数をショートハンドで定義できます。

#### 実行結果

```r
> lst <- list(
+   x = c(1, 2, 3),
+   y = c(10, 20, 30),
+   z = c(100, 200, 300)
+ )
> walk2(lst$x, lst$y, ~ print(.x + .y))
[1] 11
[1] 22
[1] 33
```


---

### `pwalk` 関数

* `pwalk` 関数は任意の数のリストやベクトルなどのデータに対して関数を適用する（戻り値はない）
* `pwalk` 関数は第1引数にデータフレームなどのリストデータを受け取り、第2引数（ `.f` ）に適用する関数を指定する
* `walk` や `pwalk2` で処理できない3つ以上の要素を持つリストをまとめて処理するときに利用できる

```r
lst <- list(
  x = c(1, 2, 3),
  y = c(10, 20, 30),
  z = c(100, 200, 300)
)
pwalk(lst, ~ print(..1 + ..2 + ..3))
```

> `walk` 関数も無名関数をショートハンドで定義できます。

#### 実行結果

```r
> lst <- list(
+   x = c(1, 2, 3),
+   y = c(10, 20, 30),
+   z = c(100, 200, 300)
+ )
> pwalk(lst, ~ print(..1 + ..2 + ..3))
[1] 111
[1] 222
[1] 333
```

