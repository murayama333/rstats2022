# 参考：仮説検定 - 独立性の検定（カイ二乗検定）

||20代|30代|40代|50代|
|:--:|:--:|:--:|:--:|:--:|
|男性|20|30|28|22|
|女性|25|26|23|26|

* クロス集計表（分割表）において、カテゴリAとカテゴリBにおいて独立性があるかを検定する
* 独立性の検定もカイ二乗分布を使って仮説検定を行う
* 帰無仮説（H0）はカテゴリーAとカテゴリーBは独立であること（関連がないこと）

> 独立性の検定では２つのカテゴリカルな変数が独立であるかをカイ二乗分布で近似して仮説検定を行います。データ数が少ないときや、データに偏りがある場合は近似できないので後述するフィッシャーの正確確率検定を使います。

---

## カイ二乗値の求め方

* `O` を観測値、`E` を理論値とおくと以下の式で求めた値は自由度 N のカイ二乗分布に従う

  <img src="img/590.png?" width="280px">

> 自由度はクロス集計表の「（カテゴリ変数Aのカテゴリ数 - 1） * （カテゴリ変数Bのカテゴリ数 - 1）」となります

---

## 例： アンケート調査

* 街頭で20代〜50代を対象に無作為に200人のアンケート調査を行った。このアンケート結果について、性別と年齢層は独立であると言えるか。

  ||男性|女性|
  ||20代|30代|40代|50代|
  |:--:|:--:|:--:|:--:|:--:|
  |男性|20|30|28|22|
  |女性|25|26|23|26|

  > ここでは表の各セルに記入されている数値を観測値と呼びます。

* 独立性の検定でも適合度検定と同様に理論値を求めます。理論値を求めるためにまずは合計を算出します。

  ||20代|30代|40代|50代|合計|
  |:--:|:--:|:--:|:--:|:--:|:--:|
  |男性|20|30|28|22|100|
  |女性|25|26|23|26|100|
  |合計|45|56|51|48|200|

* 合計値から各セルごとの理論値を計算します。ここでは性別というカテゴリ（男性・女性）は年齢層と独立と考えます。男性・女性の合計数はそれぞれ100人であるため、年齢層ごとの合計を1/2ずつ按分します。

  ||20代|30代|40代|50代|合計|
  |:--:|:--:|:--:|:--:|:--:|:--:|
  |男性|20 (22.5)|30 (28)|28 (25.5)|22 (24)|100|
  |女性|25 (22.5)|26 (28)|23 (25.5)|26 (24)|100|
  |合計|45|56|51|48|200|

  > 各セルの()の中の値が理論値です。たとえば男性の20代の理論値は `45 * 100 / 200 = 22.5` のように計算します。

* 以降は観測値と理論値から仮説検定を行います。仮説検定の手順は以下のとおりです。

  ```
  1. 帰無仮説・対立仮説を定義する
  2. 検定統計量を定義する
  3. 有意水準（α）を定義する
  4. 標本から検定統計量の実現値を算出して検証する
  ```

### 1. 帰無仮説・対立仮説を定義する

* 帰無仮説（H0）
  * 性別と年齢層は独立である（関連がないこと）
* 対立仮説（H1）
  * 性別と年齢層は独立でない（関連がある）

### 2. 検定統計量を定義する

* 検定統計量： χ2値

  <img src="img/590.png?" width="280px">

### 3. 有意水準（α）を定義する

* 有意水準（α）： 5% 片側検定

### 4. 標本から検定統計量の実現値を算出して検証する

  ||20代|30代|40代|50代|合計|
  |:--:|:--:|:--:|:--:|:--:|:--:|
  |男性|20 (22.5)|30 (28)|28 (25.5)|22 (24)|100|
  |女性|25 (22.5)|26 (28)|23 (25.5)|26 (24)|100|
  |合計|45|56|51|48|200|

* 自由度3の95%点のカイ二乗値は7.81 である

  <img src="img/591.png?" width="400px">

#### Rプログラム

```r
data_frame <- data.frame(
  x = c(55, 22, 16, 7), 
  y = c(40, 32, 24, 4)
)
total <- sum(data_frame$x + data_frame$y)
x_total <- sum(data_frame$x)
y_total <- sum(data_frame$y)
x_expected <- (data_frame$x + data_frame$y) * x_total / total
y_expected <- (data_frame$x + data_frame$y) * y_total / total
c2 <- sum((data_frame$x - x_expected)^2 / x_expected
          + (data_frame$y - y_expected)^2 / y_expected)
paste("chisq:", c2)
df <- (nrow(data_frame) - 1) * (ncol(data_frame) - 1)
paste("df:", df)
p <- pchisq(c2, df = df, lower.tail = F)
paste("p-value:", p)
```

#### 実行結果

```r
> data_frame <- data.frame(
+   x = c(55, 22, 16, 7), 
+   y = c(40, 32, 24, 4)
+ )
> total <- sum(data_frame$x + data_frame$y)
> x_total <- sum(data_frame$x)
> y_total <- sum(data_frame$y)
> x_expected <- (data_frame$x + data_frame$y) * x_total / total
> y_expected <- (data_frame$x + data_frame$y) * y_total / total
> c2 <- sum((data_frame$x - x_expected)^2 / x_expected
+           + (data_frame$y - y_expected)^2 / y_expected)
> paste("chisq:", c2)
[1] "chisq: 6.63845472266525"
> df <- (nrow(data_frame) - 1) * (ncol(data_frame) - 1)
> paste("df:", df)
[1] "df: 3"
> p <- pchisq(c2, df = df, lower.tail = F)
> paste("p-value:", p)
[1] "p-value: 0.0843592344983501"
```

#### 仮説検定

* 帰無仮説（H0）： 性別と年齢層は独立である（関連がないこと）
* 対立仮説（H1）： 性別と年齢層は独立でない（関連があること）
* 検定統計量： χ2値
* 有意水準： 5% 片側検定
* 標本：
    ||20代|30代|40代|50代|
    |:--:|:--:|:--:|:--:|:--:|
    |男性|20|30|28|22|
    |女性|25|26|23|26|
* 帰無分布： カイ二乗分布
* 臨界値： +7.81
* 棄却域： +7.81以上
* χ2値： 6.63 ※棄却域にない
* p値： 0.08
* 検定結果： 検定結果は5%水準で有意でない

以上の結果から、χ2値は棄却域にない（p値は有意水準5%を上回る）ため帰無仮説は棄却されない。

---

#### Rプログラム - 参考 `chisq.test` 関数

* `chisq.test` 関数はカイ二乗検定（独立性の検定）を行う
* `chisq.test` 関数は第1引数に標本データを指定する
* `chisq.test` 関数の引数に `collect = F` を指定することで連続値への補正（イェーツの補正）を無効にできる

```r
data_frame <- data.frame(
  x = c(55, 22, 16, 7), 
  y = c(40, 32, 24, 4)
)
chisq.test(data_frame, correct = F)
```

#### 実行結果

```r
> data_frame <- data.frame(
+   x = c(55, 22, 16, 7), 
+   y = c(40, 32, 24, 4)
+ )
> chisq.test(data_frame)

	Pearson's Chi-squared test

data:  data_frame
X-squared = 6.6385, df = 3, p-value = 0.08436
```

---

## エクササイズ

### 設問1

学生200人にプログラミング言語の利用経験についてアンケートをとった。

||R - 経験あり|R - 経験なし|
|:--|:--:|:--:|
|PHP - 経験あり|10|90|
|PHP - 経験なし|60|40|

2つのカテゴリ変数（Rの開発経験とPHPの開発経験）は独立しているといえるか。有意水準5%で仮説検定してください。

---

### 設問2

ある学習塾においてA教室、B教室の2つの教室で模擬テストを実施した。

||A判定|B判定|C判定|
|:--|:--:|:--:|:--:|
|A教室|20|10|10|
|B教室|15|25|20|

2つのカテゴリ変数（教室とテスト結果）は独立しているといえるか。有意水準5%で仮説検定してください。

<!--

設問1

> data_frame <- data.frame(
+   PHP_yes = c(10, 90), 
+   PHP_no = c(60, 40)
+ )
> chisq.test(data_frame)

	Pearson's Chi-squared test with Yates' continuity correction

data:  data_frame
X-squared = 52.769, df = 1, p-value = 3.751e-13



設問2

> data_frame <- data.frame(
+   A = c(20, 10, 10), 
+   B = c(15, 25, 20)
+ )
> chisq.test(data_frame)

	Pearson's Chi-squared test

data:  data_frame
X-squared = 6.746, df = 2, p-value = 0.03429

-->